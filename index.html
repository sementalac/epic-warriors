<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <link rel="icon"
    href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>‚öîÔ∏è</text></svg>">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Epic Warriors Online v1.44</title>
  <link
    href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=VT323:wght@400&family=MedievalSharp&display=swap"
    rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- ‚ö†Ô∏è game-globals.js PRIMERO ‚Äî define sbClient y globals antes que cualquier m√≥dulo -->
  <script src="game-globals.js?v=1.44"></script>
  <link rel="stylesheet" href="epic-warriors.css?v=1.44">
</head>

<body>
  <div class="stars" id="stars"></div>
  <div class="notif-wrap" id="notifWrap"></div>

  <!-- AUTH -->
  <div class="auth-screen" id="authScreen">
    <div class="auth-box">
      <div class="auth-logo">&#x2B21; EPIC WARRIORS</div>
      <div class="auth-tagline">CONQUISTA EL MUNDO</div>
      <div class="auth-tabs">
        <button class="auth-tab active" id="btnTL" onclick="switchTab('login')">Iniciar Sesion</button>
        <button class="auth-tab" id="btnTR" onclick="switchTab('register')">Registrarse</button>
      </div>
      <div id="tabL">
        <div class="auth-field"><label class="auth-label">Email</label><input class="auth-input" type="email"
            id="lEmail" placeholder="comandante@galaxia.com" onkeypress="if(event.key==='Enter')doLogin()"></div>
        <div class="auth-field"><label class="auth-label">Contrasena</label><input class="auth-input" type="password"
            id="lPass" placeholder="..." onkeypress="if(event.key==='Enter')doLogin()"></div>
        <button class="auth-btn" id="lBtn" onclick="doLogin()">Entrar</button>
      </div>
      <div id="tabR" style="display:none">
        <div class="auth-field"><label class="auth-label">Nombre de usuario</label><input class="auth-input" type="text"
            id="rUser" oninput="onUserInput()" placeholder="Ej: Jesus_33" maxlength="15" autocapitalize="off"
            autocomplete="nickname"></div>

        <div class="auth-field"><label class="auth-label">Email</label><input class="auth-input" type="email"
            id="rEmail" placeholder="comandante@galaxia.com" onkeypress="if(event.key==='Enter')doRegister()"></div>
        <div class="auth-field"><label class="auth-label">Contrasena</label><input class="auth-input" type="password"
            id="rPass" placeholder="Min. 6 caracteres" onkeypress="if(event.key==='Enter')doRegister()"></div>
        <div class="auth-msg" id="userMsg" style="text-align:left;margin:-6px 0 8px;min-height:18px;"></div>
        <button class="auth-btn" id="rBtn" onclick="doRegister()">Crear Cuenta</button>
      </div>
      <div class="auth-msg" id="authMsg"></div>
    </div>
  </div>

  <!-- GAME -->
  <div class="game-wrapper" id="gameWrapper">
    <header class="topbar">
      <div class="logo">&#x2B21; EPIC</div>
      <div class="res-bar">

        <div class="res-chip ma">
          <div class="res-chip-top"><span class="res-icon">üå≤</span>
            <div class="res-info"><span class="res-name">Madera</span><span class="res-val" id="rMadera">0</span><span
                class="res-rate" id="rMaderaR">+0/h</span></div>
          </div>
          <div class="cap-bar-wrap">
            <div class="cap-bar ok" id="capBarMa" style="width:0%"></div>
          </div>
        </div>

        <div class="res-chip pi">
          <div class="res-chip-top"><span class="res-icon">‚õ∞Ô∏è</span>
            <div class="res-info"><span class="res-name">Piedra</span><span class="res-val" id="rPiedra">0</span><span
                class="res-rate" id="rPiedraR">+0/h</span></div>
          </div>
          <div class="cap-bar-wrap">
            <div class="cap-bar ok" id="capBarPi" style="width:0%"></div>
          </div>
        </div>

        <div class="res-chip hi">
          <div class="res-chip-top"><span class="res-icon">‚öôÔ∏è</span>
            <div class="res-info"><span class="res-name">Hierro</span><span class="res-val" id="rHierro">0</span><span
                class="res-rate" id="rHierroR">+0/h</span></div>
          </div>
          <div class="cap-bar-wrap">
            <div class="cap-bar ok" id="capBarHi" style="width:0%"></div>
          </div>
        </div>

        <div class="res-chip pr">
          <div class="res-chip-top"><span class="res-icon">üåæ</span>
            <div class="res-info"><span class="res-name">Provisiones</span><span class="res-val"
                id="rProv">0</span><span class="res-rate" id="rProvR">+0/h</span></div>
          </div>
          <div class="cap-bar-wrap">
            <div class="cap-bar ok" id="capBarPr" style="width:0%"></div>
          </div>
        </div>

        <div class="res-chip es">
          <div class="res-chip-top"><span class="res-icon">‚ú®</span>
            <div class="res-info"><span class="res-name">Esencia</span><span class="res-val" id="rEsencia">0</span><span
                class="res-rate" id="rEsenciaR">+0/h</span></div>
          </div>
          <div class="cap-bar-wrap" style="background:rgba(192,96,255,.12)">
            <div class="cap-bar" style="width:0%;background:var(--esencia);" id="capBarEs"></div>
          </div>
        </div>

        <div class="res-chip" style="color:var(--aldeanos);border-color:rgba(255,221,96,.3)">
          <div class="res-chip-top"><span class="res-icon">üë§</span>
            <div class="res-info">
              <span class="res-name" style="color:var(--dim)">Aldeanos</span>
              <span class="res-val" style="color:var(--aldeanos)" id="rAldeanos">0</span>
              <div style="display:flex;justify-content:space-between;align-items:center;gap:6px;">
                <span class="res-rate" id="rTropasBase" style="color:var(--dim);">0</span>
                <span class="res-rate" id="rBarrCap" style="color:var(--dim);">/ 0</span>
              </div>
            </div>
          </div>
          <div class="cap-bar-wrap">
            <div class="cap-bar ok" id="capBarAld" style="width:0%;background:var(--aldeanos);"></div>
          </div>
        </div>

      </div>
      <div class="topbar-right">
        <div class="save-dot" id="saveDot"></div>
        <span class="save-txt" id="saveTxt">guardado</span>
        <span id="activePlayers"
          style="font-size:.65rem;color:var(--ok);letter-spacing:.05em;padding:2px 8px;background:rgba(79,255,176,.08);border:1px solid rgba(79,255,176,.2);border-radius:4px;">üü¢
          0 online</span>
        <select class="village-sel" id="villageSel" onchange="switchVillage(this.value)"></select>
        <button id="adminBtn" onclick="openAdmin()"
          style="display:none;background:rgba(255,61,90,.08);border:1px solid rgba(255,61,90,.3);border-radius:4px;color:rgba(255,61,90,.7);padding:5px 10px;font-size:.68rem;cursor:pointer;font-family:'VT323',monospace;letter-spacing:.06em;">‚öô
          ADMIN</button>
        <button onclick="openProfile()"
          style="background:rgba(240,192,64,.08);border:1px solid rgba(240,192,64,.25);border-radius:4px;color:var(--gold);padding:5px 10px;font-size:.68rem;cursor:pointer;font-family:'VT323',monospace;letter-spacing:.06em;">üë§
          <span id="topbarUsername">...</span></button>
        <button id="alertsBtn" onclick="toggleAlertsPanel()">
          üîî <span id="alertsBtnLabel">Alertas</span>
          <span id="alertsBadge"
            style="display:none;position:absolute;top:-6px;right:-6px;background:var(--danger);color:#fff;font-size:.55rem;width:16px;height:16px;border-radius:50%;align-items:center;justify-content:center;font-weight:bold;">0</span>
        </button>
        <button class="logout-btn" onclick="doLogout()">Salir</button>
      </div>
    </header>
    <div class="main-layout">
      <nav class="sidebar">
        <div class="nav-section">
          <div class="nav-label">Colonia</div>
          <div class="nav-item active" onclick="showPage('overview',this)"><span class="nav-icon">&#x1F310;</span>
            Vision General</div>
          <div class="nav-item" onclick="showPage('buildings',this)"><span class="nav-icon">&#x1F3D7;</span> Edificios
          </div>
          <div class="nav-item" onclick="showPage('recursos',this)"><span class="nav-icon">&#x1F33E;</span> Recursos
          </div>
        </div>
        <div class="nav-section">
          <div class="nav-label">Mundo</div>
          <div class="nav-item" onclick="showPage('map',this)"><span class="nav-icon">&#x1F5FA;</span> Mapa</div>
        </div>
        <div class="nav-section">
          <div class="nav-label">Militar</div>
          <div class="nav-item" onclick="showPage('fleet',this)"><span class="nav-icon">‚öîÔ∏è</span> Tropas</div>
          <div class="nav-item" onclick="showPage('creatures',this)"><span class="nav-icon">üêâ</span> Criaturas</div>
          <div class="nav-item" onclick="showPage('defense',this)"><span class="nav-icon">&#x1F6E1;</span> Defensa</div>
          <div class="nav-item" onclick="window.open('battle-simulator.html','_blank')"><span
              class="nav-icon">&#x2694;&#xFE0F;</span> Simulador</div>
        </div>
        <div class="nav-section">
          <div class="nav-label">Ciencia</div>
          <div class="nav-item" onclick="showPage('research',this)"><span class="nav-icon">&#x1F52C;</span>
            Investigacion</div>
          <div class="nav-item" onclick="showPage('smithy',this);renderSmithy()"><span class="nav-icon">üî®</span> Herrer√≠a</div>
        </div>
        <div class="nav-section">
          <div class="nav-label">Social</div>
          <div class="nav-item" onclick="showPage('ranking',this)"><span class="nav-icon">&#x1F3C6;</span> Ranking</div>
          <div class="nav-item" onclick="showPage('alliances',this)"><span class="nav-icon">&#x1F6E1;</span> Alianzas
          </div>
          <div class="nav-item" id="navMessages" onclick="showPage('messages',this)"><span
              class="nav-icon">üì®</span> Mensajes<span id="msgBadge" class="msg-badge"
              style="display:none;">0</span>
          </div>
        </div>
      </nav>
      <main class="content">
        <div class="page active" id="page-overview">
          <div class="page-title">VISION GENERAL</div>

          <!-- Player profile card -->
          <div class="card" style="margin-bottom:14px;">
            <div style="display:flex;align-items:center;gap:16px;flex-wrap:wrap;margin-bottom:16px;">
              <div style="font-size:3.5rem;line-height:1;">üëë</div>
              <div style="flex:1;min-width:0;">
                <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;flex-wrap:wrap;">
                  <span style="font-size:1.5rem;color:var(--accent);font-family:VT323,monospace;" id="ovUser">--</span>
                  <span style="font-size:.8rem;color:var(--accent2);" id="ovAlliance"></span>
                </div>
                <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;">
                  <span class="planet-name-big" id="ovVillageName"
                    style="font-size:1rem;color:var(--dim);">Cargando...</span>
                  <button onclick="startRename()"
                    style="background:rgba(0,212,255,.08);border:1px solid rgba(0,212,255,.3);border-radius:4px;color:var(--accent);font-family:'VT323',monospace;font-size:.62rem;padding:2px 7px;cursor:pointer;">‚úè</button>
                </div>
                <div id="renameForm" style="display:none;margin-top:8px;">
                  <input id="renameInput"
                    style="background:rgba(255,255,255,.05);border:1px solid var(--accent);border-radius:4px;padding:5px 10px;color:var(--text);font-family:'VT323',monospace;font-size:.82rem;outline:none;width:200px;"
                    placeholder="Nuevo nombre...">
                  <button onclick="confirmRename()"
                    style="margin-left:6px;background:rgba(79,255,176,.1);border:1px solid var(--ok);border-radius:4px;color:var(--ok);font-family:'VT323',monospace;font-size:.72rem;padding:5px 10px;cursor:pointer;">‚úì</button>
                  <button onclick="cancelRename()"
                    style="margin-left:4px;background:rgba(255,61,90,.08);border:1px solid rgba(255,61,90,.3);border-radius:4px;color:var(--danger);font-family:'VT323',monospace;font-size:.72rem;padding:5px 10px;cursor:pointer;">‚úï</button>
                </div>
                <div class="planet-coords" id="ovVillageCoords"
                  style="font-size:.68rem;color:var(--dim);margin-top:4px;">--</div>
              </div>
            </div>

            <!-- Stats: XP + Battles solo, sin recursos -->
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
              <div
                style="background:var(--panel2);border-radius:8px;padding:14px;text-align:center;border:1px solid rgba(240,192,64,.15);">
                <div style="font-size:.62rem;color:var(--dim);letter-spacing:.12em;margin-bottom:6px;">‚≠ê EXPERIENCIA
                </div>
                <div style="font-size:1.6rem;color:var(--gold);font-weight:bold;font-family:VT323,monospace;"
                  id="ovExperience">0</div>
              </div>
              <div
                style="background:var(--panel2);border-radius:8px;padding:14px;text-align:center;border:1px solid rgba(255,61,90,.12);">
                <div style="font-size:.62rem;color:var(--dim);letter-spacing:.12em;margin-bottom:6px;">‚öîÔ∏è BATALLAS JvJ
                </div>
                <div style="font-size:1.2rem;margin-top:2px;font-family:VT323,monospace;">
                  <span style="color:var(--ok);" id="ovBattlesWon">0</span>
                  <span style="color:var(--dim);font-size:.9rem;"> V ¬∑ </span>
                  <span style="color:var(--danger);" id="ovBattlesLost">0</span>
                  <span style="color:var(--dim);font-size:.9rem;"> D</span>
                </div>
                <div style="font-size:.58rem;color:var(--dim);margin-top:2px;">Solo contra jugadores</div>
              </div>
              <div
                style="background:var(--panel2);border-radius:8px;padding:14px;text-align:center;border:1px solid rgba(80,208,144,.12);grid-column:1/-1;">
                <div style="font-size:.62rem;color:var(--dim);letter-spacing:.12em;margin-bottom:6px;">üè∞ VICTORIAS NPC
                </div>
                <div style="font-size:1.6rem;color:var(--ok);font-weight:bold;font-family:VT323,monospace;"
                  id="ovBattlesNPC">0</div>
                <div style="font-size:.58rem;color:var(--dim);margin-top:2px;">Castillos + Aldeas fantasma</div>
              </div>
            </div>
          </div>

          <!-- Troop movement alerts -->
          <div class="card" style="margin-bottom:14px;">
            <div class="h2">‚ö†Ô∏è Movimientos de tropas</div>
            <div id="ovAlertsBox" style="margin-top:8px;font-size:.8rem;color:var(--dim);">Sin alertas activas.</div>
          </div>

          <!-- Refuerzos estacionados en esta aldea -->
          <div class="card" style="margin-bottom:14px;" id="ovReinforcementsCard" style="display:none;">
            <div class="h2">üõ°Ô∏è Refuerzos estacionados</div>
            <div id="ovReinforcementsBox" style="margin-top:8px;font-size:.8rem;color:var(--dim);">Sin refuerzos.</div>
          </div>

          <!-- Build queue -->
          <div class="queue-panel">
            <div class="queue-title">CONSTRUCCION EN CURSO</div>
            <div class="queue-empty" id="qEmptyOv">Sin construcciones activas.</div>
            <div id="qItemsOv"></div>
          </div>
        </div>

        <!-- RECURSOS PAGE -->
        <div class="page" id="page-recursos">
          <div class="page-title">RECURSOS</div>
          <div class="page-sub">Asigna aldeanos a cada recurso para aumentar su producci√≥n. Los edificios garantizan una
            base m√≠nima.</div>

          <!-- Resumen aldeanos -->
          <div class="queue-panel" style="border-color:rgba(255,221,96,.2);margin-bottom:14px;">
            <div style="display:flex;gap:20px;flex-wrap:wrap;align-items:center;">
              <span style="font-size:.8rem;">üë§ Libres: <b id="recAldLibres" style="color:var(--aldeanos)">0</b></span>
              <span style="font-size:.8rem;">‚öíÔ∏è Trabajando: <b id="recAldWorking"
                  style="color:var(--accent2)">0</b></span>
              <span style="font-size:.8rem;">üè† Barracas: <b id="recAldCap" style="color:var(--dim)">0</b> plazas</span>
              <span style="font-size:.8rem;">üì¶ Almac√©n: <b id="recAlmPct" style="color:var(--gold)">0%</b>
                ocupado</span>
            </div>
          </div>

          <!-- Cards de recursos con barras -->
          <div class="recursos-grid" id="recursosGrid"></div>
        </div>

        <!-- ADMIN USUARIOS PAGE -->
        <div class="page" id="page-buildings">
          <div class="page-title">EDIFICIOS</div>
          <div class="page-sub">Construye y mejora las estructuras de tu colonia</div>
          <div class="queue-panel">
            <div class="queue-title">COLA DE CONSTRUCCION</div>
            <div class="queue-empty" id="qEmpty">Sin construcciones activas.</div>
            <div id="qItems"></div>
          </div>
          <div class="bld-grid" id="bldGrid"></div>
        </div>

        <div class="page" id="page-map">
          <div class="page-title">MAPA MUNDIAL</div>
          <div class="page-sub">Vista 15√ó15 centrada ‚Äî usa ‚Üë‚Üì‚Üê‚Üí o WASD para moverte. Mapa de 380√ó380</div>
          <div class="map-page-layout">
            <div class="map-main-col">
              <div class="map-container">
                <div class="map-header">
                  <div class="map-legend">
                    <div class="legend-item">
                      <div class="legend-dot" style="background:rgba(0,212,255,.5)"></div><span>Tu aldea</span>
                    </div>
                    <div class="legend-item">
                      <div class="legend-dot" style="background:rgba(255,61,90,.5)"></div><span>Aldea enemiga</span>
                    </div>
                    <div class="legend-item">
                      <div class="legend-dot" style="background:rgba(255,230,0,.5)"></div><span>Castillo
                        Caballero</span>
                    </div>
                    <div class="legend-item">
                      <div class="legend-dot" style="background:rgba(255,255,255,.04)"></div><span>Vacio</span>
                    </div>
                  </div>
                  <div class="map-nav-pad">
                    <div class="map-nav-row"><button class="map-nav-btn" onclick="panMap(0,-1)"
                        title="Arriba">‚Üë</button>
                    </div>
                    <div class="map-nav-row">
                      <button class="map-nav-btn" onclick="panMap(-1,0)" title="Izquierda">‚Üê</button>
                      <button class="map-nav-btn" onclick="panMap(0,0,true)" title="Centrar en tu aldea">‚åÇ</button>
                      <button class="map-nav-btn" onclick="panMap(1,0)" title="Derecha">‚Üí</button>
                    </div>
                    <div class="map-nav-row"><button class="map-nav-btn" onclick="panMap(0,1)" title="Abajo">‚Üì</button>
                    </div>
                  </div>
                </div>
                <div class="map-coords-display" id="mapCoordsDisplay">Cargando mapa...</div>
                <div style="display:flex;gap:6px;align-items:center;margin-top:6px;">
                  <span style="font-size:.68rem;color:var(--dim);">Ir a:</span>
                  <input id="mapGoX" type="number" placeholder="X"
                    style="width:54px;background:rgba(255,255,255,.06);border:1px solid var(--border);border-radius:4px;padding:3px 6px;color:var(--text);font-family:VT323,monospace;font-size:.8rem;text-align:center;">
                  <span style="color:var(--dim);">,</span>
                  <input id="mapGoY" type="number" placeholder="Y"
                    style="width:54px;background:rgba(255,255,255,.06);border:1px solid var(--border);border-radius:4px;padding:3px 6px;color:var(--text);font-family:VT323,monospace;font-size:.8rem;text-align:center;">
                  <button onclick="goToCoords()"
                    style="background:rgba(0,212,255,.1);border:1px solid var(--accent);border-radius:4px;color:var(--accent);font-family:VT323,monospace;font-size:.75rem;padding:3px 10px;cursor:pointer;">Ir</button>
                </div>
                <div class="map-grid-wrap">
                  <div class="map-grid" id="mapGrid"></div>
                </div>
                <div class="map-panel" id="mapPanel">
                  <div class="map-panel-title" id="mapPanelTitle">--</div>
                  <div class="map-panel-sub" id="mapPanelSub">--</div>
                  <div class="map-actions" id="mapActions"></div>
                </div>
              </div>
            </div><!-- /map-main-col -->
            <div class="map-mini-col">
              <div class="minimap-box">
                <div class="minimap-title">üó∫ RADAR ‚Äî 30√ó30</div>
                <canvas id="minimapCanvas" width="270" height="270"
                  title="Radar ‚Äî vista amplia no interactiva"></canvas>
                <div class="minimap-legend">
                  <div class="minimap-legend-item">
                    <div class="minimap-legend-dot" style="background:rgba(0,212,255,.8)"></div>Tu aldea
                  </div>
                  <div class="minimap-legend-item">
                    <div class="minimap-legend-dot" style="background:rgba(96,208,96,.8)"></div>Aliado
                  </div>
                  <div class="minimap-legend-item">
                    <div class="minimap-legend-dot" style="background:rgba(255,61,90,.8)"></div>Enemigo
                  </div>
                  <div class="minimap-legend-item">
                    <div class="minimap-legend-dot" style="background:rgba(255,230,0,.7)"></div>NPC
                  </div>
                </div>
              </div>
            </div><!-- /map-mini-col -->
          </div><!-- /map-page-layout -->
        </div>

        <div class="page" id="page-fleet">
          <div class="page-title">TROPAS</div>
          <div class="page-sub">Entrenamiento y unidades disponibles</div>

          <div class="card" style="margin-bottom:14px;">
            <div class="h2">‚è≥ Cola de entrenamiento</div>
            <div id="trainingQueueBox" style="margin-top:10px;"></div>
          </div>

          <div class="card" style="margin-bottom:14px;">
            <div class="h2">‚öîÔ∏è Entrenar tropas</div>
            <div class="muted" style="font-size:.7rem;margin-bottom:10px;">Pulsa el icono para ver estad√≠sticas. Los
              aldeanos se descuentan y materiales al encolar.</div>
            <div id="trainOptionsBox" style="margin-top:10px;"></div>
          </div>

          <!-- troopsListBox eliminado ‚Äî integrado en trainOptionsBox -->
          <div id="troopsListBox" style="display:none;"></div>
        </div>
        <div class="page" id="page-creatures">
          <div class="page-title">üêâ CRIATURAS</div>
          <div class="page-sub">Criaturas invocadas - No ocupan barracas ni consumen provisiones</div>

          <div class="card" style="margin-bottom:14px;">
            <div class="h2">üîÆ Torre de Invocaci√≥n</div>
            <div id="torreInvocacionInfo" style="font-size:.82rem;margin-top:8px;color:var(--gold);">‚Äî</div>
            <div class="muted" style="margin-top:4px;font-size:.7rem;">Cada nivel reduce -5% el tiempo de invocaci√≥n.
            </div>
          </div>

          <div class="card" style="margin-bottom:14px;">
            <div class="h2">üìã Cola de Invocaci√≥n</div>
            <div id="summoningQueueBox" style="margin-top:10px;">‚Äî</div>
          </div>

          <div class="card" style="margin-bottom:14px;">
            <div class="h2">üëπ Criaturas Disponibles</div>
            <div id="creaturesListBox" style="margin-top:10px;"></div>
          </div>

          <div class="card">
            <div class="h2">‚ö° Invocar Criatura</div>
            <div id="summonBox" style="margin-top:10px;"></div>
          </div>
        </div>
        <div class="page" id="page-defense">
          <div class="coming-soon">
            <div class="cs-icon">&#x1F6E1;</div>
            <div class="cs-title">MODULO DE DEFENSA</div>
            <div>Proximamente</div>
          </div>
        </div>

        <div class="page" id="page-simulator">
          <div class="page-title">‚öîÔ∏è SIMULADOR DE BATALLA</div>
          <div class="page-sub">Prueba combinaciones de tropas antes de atacar</div>
          <div id="simulatorContent" style="padding:16px;">
            <p style="color:var(--dim);font-size:.85rem;">Selecciona un caballero desde el mapa y pulsa "Simular" para
              ver el resultado estimado del combate antes de enviar tus tropas.</p>
          </div>
        </div>
        <div class="page" id="page-research">
          <div class="page-title">CENTRO DE INVESTIGACI√ìN</div>
          <div class="page-sub">Mejora el nivel de tus tropas gastando experiencia</div>

          <!-- XP disponible -->
          <div class="card" style="margin-bottom:14px;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px;">
            <div>
              <div class="muted" style="font-size:.72rem;margin-bottom:2px;">TU EXPERIENCIA DISPONIBLE</div>
              <div id="researchXPDisplay" style="font-size:1.3rem;color:var(--gold);font-weight:700;">‚Äî</div>
            </div>
            <button class="btn btn-sm" onclick="renderResearch()">‚Üª Actualizar</button>
          </div>

          <!-- Tabla de tropas -->
          <div class="card" id="researchTroopGrid" style="display:grid;gap:12px;">
            <div class="muted">Cargando‚Ä¶</div>
          </div>

          <!-- Leyenda stats -->
          <div class="card" style="margin-top:14px;font-size:.72rem;color:var(--dim);line-height:1.8;">
            <div style="color:var(--accent);font-weight:700;margin-bottom:6px;">üìñ Efectos por nivel de tropa</div>
            <div>Cada nivel sube los stats seg√∫n la tabla oficial (HP, Da√±o, Defensa, etc.).</div>
            <div>Nivel m√°ximo: <strong style="color:var(--gold);">30</strong> &nbsp;|&nbsp; Los aldeanos cuestan XP reducida (√ó2 en lugar de √ó10).</div>
          </div>
        </div>

        <div class="page" id="page-smithy">
          <div class="page-title">HERRER√çA</div>
          <div class="page-sub">Mejora el arma y la armadura de cada tipo de tropa</div>
          <div id="smithyContent">
            <div class="muted" style="padding:20px;text-align:center;">Cargando‚Ä¶</div>
          </div>
        </div>

        <div class="page" id="page-ranking">
          <div class="page-title">RANKING</div>
          <div class="page-sub">Clasificaci√≥n militar ‚Äî cada tropa cuenta 1 punto</div>
          <div class="card">
            <div style="display:flex;gap:10px;align-items:center;justify-content:space-between;">
              <div class="muted">Se actualiza autom√°ticamente cada 6 horas.</div>
              <button class="btn" onclick="forceRefreshRanking()">‚Üª Forzar actualizaci√≥n</button>
            </div>
            <div id="rankingBox" style="margin-top:12px;"></div>
          </div>
        </div>

        <div class="page" id="page-alliances">
          <div class="page-title">ALIANZAS</div>
          <div class="page-sub">Crear, solicitar, gestionar y comunicarse</div>

          <!-- CABECERA MI ALIANZA -->
          <div class="card" style="margin-bottom:14px;">
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;">
              <div class="h2">Mi alianza</div>
              <button class="btn btn-sm" onclick="renderAlliances()">&#x21BB; Actualizar</button>
            </div>
            <div id="myAllianceBox" class="muted">Cargando&#x2026;</div>
          </div>

          <!-- SIN ALIANZA -->
          <div id="alNoAlliancePanel">
            <div class="grid2">
              <div class="card">
                <div class="h2">Crear alianza</div>
                <div class="muted" style="margin-bottom:10px;">Nombre + Tag (2-6 letras). Ser&#xE1;s el l&#xED;der.
                </div>
                <div style="display:grid;grid-template-columns:1fr 110px;gap:8px;">
                  <input id="alName" class="input" placeholder="Nombre de alianza" maxlength="40" />
                  <input id="alTag" class="input" placeholder="TAG" maxlength="6" style="text-transform:uppercase;" />
                </div>
                <button class="btn" style="margin-top:10px;" onclick="createAlliance()">&#x2694; Crear alianza</button>
                <div id="createAllianceMsg" class="muted" style="margin-top:8px;min-height:16px;"></div>
              </div>
              <div class="card">
                <div class="h2">Solicitar unirse</div>
                <div class="muted" style="margin-bottom:10px;">Busca una alianza en la lista y pulsa Solicitar. El
                  l&#xED;der deber&#xE1; aceptarte.</div>
                <div id="alPendingMsg" class="muted" style="min-height:16px;"></div>
              </div>
            </div>
            <div class="card" style="margin-top:14px;">
              <div class="h2">Alianzas activas</div>
              <div id="alliancesBox" style="margin-top:8px;"></div>
            </div>
          </div>

          <!-- MIEMBRO ACTIVO (no l&#xED;der) -->
          <div id="alMemberPanel" style="display:none;">
            <div class="card" style="margin-bottom:14px;border-left:3px solid var(--accent);">
              <div class="h2" style="margin-bottom:6px;">üì¢ Tabl√≥n de anuncios</div>
              <div id="alAnnouncementDisplay" class="muted"
                style="font-size:.8rem;line-height:1.5;white-space:pre-wrap;min-height:32px;">Sin anuncios.</div>
            </div>
            <div class="grid2">
              <div class="card">
                <div class="h2">Miembros</div>
                <div id="alMembersList" class="muted">Cargando&#x2026;</div>
              </div>
              <div class="card">
                <div class="h2">Acciones</div>
                <button class="btn" style="width:100%;margin-bottom:8px;" onclick="openAllianceChat()">&#x1F4AC; Chat de
                  alianza</button>
                <button class="btn"
                  style="width:100%;background:rgba(224,64,64,.1);border-color:var(--danger);color:var(--danger);"
                  onclick="leaveAlliance()">&#x1F6AA; Salir de la alianza</button>
              </div>
            </div>
          </div>

          <!-- L&#xCD;DER -->
          <div id="alLeaderPanel" style="display:none;">
            <div class="grid2">
              <div class="card">
                <div class="h2">Miembros activos</div>
                <div id="alLeaderMembersList" class="muted">Cargando&#x2026;</div>
              </div>
              <div class="card">
                <div class="h2">Solicitudes pendientes</div>
                <div id="alPendingList" class="muted">Cargando&#x2026;</div>
              </div>
            </div>
            <div class="card" style="margin-top:14px;">
              <div class="h2">Invitar jugador</div>
              <div style="display:flex;gap:8px;margin-top:8px;">
                <input id="alInviteUser" class="input" placeholder="Nombre de usuario&#x2026;" style="flex:1;"
                  onkeydown="if(event.key==='Enter') inviteToAlliance()" />
                <button class="btn" onclick="inviteToAlliance()">Invitar</button>
              </div>
              <div id="alInviteMsg" class="muted" style="margin-top:8px;min-height:16px;"></div>
            </div>
            <div class="card" style="margin-top:14px;border-left:3px solid var(--accent);">
              <div class="h2" style="margin-bottom:6px;">üì¢ Tabl√≥n de anuncios</div>
              <div class="muted" style="font-size:.72rem;margin-bottom:8px;">Visible para todos los miembros al entrar
                en Alianzas.</div>
              <textarea id="alAnnouncementInput" class="input" rows="3"
                placeholder="Escribe un anuncio para tu alianza‚Ä¶"
                style="width:100%;resize:vertical;font-family:VT323,monospace;font-size:.85rem;line-height:1.4;"></textarea>
              <button class="btn" style="margin-top:8px;" onclick="saveAllianceAnnouncement()">üíæ Guardar
                anuncio</button>
              <div id="alAnnouncementMsg" class="muted" style="margin-top:6px;min-height:14px;font-size:.72rem;"></div>
            </div>
            <div class="card" style="margin-top:14px;">
              <div class="h2">Acciones de l&#xED;der</div>
              <div style="display:flex;gap:8px;flex-wrap:wrap;">
                <button class="btn" onclick="openAllianceChat()">&#x1F4AC; Chat de alianza</button>
                <button class="btn"
                  style="background:rgba(224,64,64,.1);border-color:var(--danger);color:var(--danger);"
                  onclick="dissolveAlliance()">&#x1F4A3; Disolver alianza</button>
              </div>
            </div>
          </div>

          <!-- PENDIENTE / INVITADO -->
          <div id="alPendingPanel" style="display:none;">
            <div class="card">
              <div id="alPendingStatusBox" class="muted">Cargando&#x2026;</div>
              <div style="display:flex;gap:8px;margin-top:12px;flex-wrap:wrap;" id="alPendingActions"></div>
            </div>
          </div>
          <!-- v1.22: Ranking colectivo de alianzas -->
          <div class="card" style="margin-top:14px;">
            <div class="h2">üèÜ Ranking de alianzas</div>
            <div id="allianceRankingBox" class="muted" style="margin-top:8px;">Cargando&#x2026;</div>
          </div>
        </div>

        <div class="page" id="page-messages">
          <div class="page-title">MENSAJES</div>
          <div class="page-sub">Sistema ¬∑ Alianza ¬∑ Mensajes directos</div>

          <div
            style="display:grid;grid-template-columns:280px 360px 1fr;gap:16px;height:calc(100vh - 200px);min-height:420px;">

            <!-- ‚îÄ‚îÄ PANEL IZQUIERDO: bandeja ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
            <div
              style="display:flex;flex-direction:column;gap:0;background:var(--panel);border:1px solid var(--border);border-radius:8px;overflow:hidden;">

              <!-- Cabecera + acciones r√°pidas -->
              <div style="padding:14px 14px 10px;border-bottom:1px solid var(--border);">
                <div style="font-size:.7rem;letter-spacing:.12em;color:var(--accent);margin-bottom:10px;">üì¨ BANDEJA
                </div>

                <!-- DM -->
                <div style="display:flex;gap:6px;margin-bottom:8px;">
                  <input id="dmUser" placeholder="Username para DM‚Ä¶"
                    style="flex:1;background:rgba(255,255,255,.04);border:1px solid var(--border);border-radius:4px;padding:6px 8px;color:var(--text);font-family:VT323,monospace;font-size:.78rem;outline:none;"
                    onkeydown="if(event.key==='Enter') startDM()" />
                  <button onclick="startDM()"
                    style="padding:5px 10px;background:rgba(240,192,64,.1);border:1px solid var(--accent);border-radius:4px;color:var(--accent);font-family:VT323,monospace;font-size:.75rem;cursor:pointer;white-space:nowrap;">‚úâ
                    DM</button>
                </div>

                <!-- Botones r√°pidos -->
                <div style="display:flex;gap:6px;">
                  <button onclick="openAllianceChat()"
                    style="flex:1;padding:5px 4px;background:rgba(96,208,96,.08);border:1px solid var(--accent2);border-radius:4px;color:var(--accent2);font-family:VT323,monospace;font-size:.72rem;cursor:pointer;">‚öî
                    Alianza</button>
                  <button onclick="openSystemThread()"
                    style="flex:1;padding:5px 4px;background:rgba(192,96,255,.08);border:1px solid var(--esencia);border-radius:4px;color:var(--esencia);font-family:VT323,monospace;font-size:.72rem;cursor:pointer;">üîî
                    Sistema</button>
                  <button onclick="renderThreads()"
                    style="flex:1;padding:5px 4px;background:rgba(255,255,255,.04);border:1px solid var(--border);border-radius:4px;color:var(--dim);font-family:VT323,monospace;font-size:.72rem;cursor:pointer;">‚Üª</button>
                </div>
              </div>

              <!-- Lista de hilos -->
              <div id="threadsBox" style="flex:1;overflow-y:auto;padding:6px 0;"></div>
            </div>

            <!-- ‚îÄ‚îÄ PANEL CENTRAL: lista de reportes ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
            <div id="reportsList"
              style="display:none;flex-direction:column;background:var(--panel);border:1px solid var(--border);border-radius:8px;overflow:hidden;">

              <!-- Header con acciones -->
              <div
                style="padding:10px 14px;border-bottom:1px solid var(--border);display:flex;flex-direction:column;gap:8px;">
                <!-- Fila 1: t√≠tulo + marcar le√≠dos -->
                <div style="display:flex;align-items:center;justify-content:space-between;">
                  <div style="font-size:.8rem;color:var(--accent);letter-spacing:.08em;">üìã INFORMES</div>
                  <button onclick="markAllSystemAsRead()"
                    style="padding:4px 8px;background:rgba(96,208,96,.1);border:1px solid var(--accent2);border-radius:4px;color:var(--accent2);font-family:VT323,monospace;font-size:.65rem;cursor:pointer;">‚úì
                    Marcar le√≠dos</button>
                </div>
                <!-- Fila 2: selecci√≥n m√∫ltiple -->
                <div style="display:flex;align-items:center;gap:8px;">
                  <label
                    style="display:flex;align-items:center;gap:4px;font-size:.65rem;color:var(--dim);cursor:pointer;user-select:none;">
                    <input type="checkbox" id="selectAllReportsChk"
                      style="width:13px;height:13px;cursor:pointer;accent-color:var(--danger);"
                      onchange="selectAllReports(this.checked)">
                    Todo
                  </label>
                  <span id="reportsSelCount" style="flex:1;font-size:.62rem;color:var(--dim);"></span>
                  <button id="reportsDeleteSelBtn" onclick="deleteSelectedReports()"
                    style="display:none;padding:3px 10px;background:rgba(224,64,64,.12);border:1px solid var(--danger);border-radius:4px;color:var(--danger);font-family:VT323,monospace;font-size:.65rem;cursor:pointer;">üóë
                    Eliminar sel.</button>
                </div>
              </div>

              <!-- Lista scrolleable -->
              <div id="reportsListBox" style="flex:1;overflow-y:auto;padding:6px;"></div>
            </div>

            <!-- ‚îÄ‚îÄ PANEL DERECHO: reporte completo o chat ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
            <div
              style="display:flex;flex-direction:column;background:var(--panel);border:1px solid var(--border);border-radius:8px;overflow:hidden;">

              <!-- Cabecera -->
              <div id="chatHeader"
                style="padding:12px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px;min-height:48px;">
                <span style="color:var(--dim);font-size:.78rem;">Selecciona una conversaci√≥n‚Ä¶</span>
              </div>

              <!-- Contenido: chat o reporte -->
              <div id="chatBox" style="flex:1;overflow-y:auto;padding:14px 16px;"></div>

              <!-- Input env√≠o (oculto hasta que haya hilo activo) -->
              <div id="chatInputArea"
                style="padding:10px 14px;border-top:1px solid var(--border);display:none;gap:8px;align-items:center;">
                <input id="chatMsg" placeholder="Escribe un mensaje‚Ä¶"
                  style="flex:1;background:rgba(255,255,255,.04);border:1px solid var(--border);border-radius:6px;padding:8px 12px;color:var(--text);font-family:VT323,monospace;font-size:.85rem;outline:none;"
                  onkeydown="if(event.key==='Enter') sendChatMsg()" />
                <button onclick="sendChatMsg()"
                  style="padding:7px 16px;background:rgba(240,192,64,.12);border:1px solid var(--accent);border-radius:6px;color:var(--accent);font-family:VT323,monospace;font-size:.82rem;cursor:pointer;">Enviar</button>
              </div>
            </div>
          </div>
        </div>

        <!-- v1.17: P√°gina de usuarios admin (solo para sementalac@gmail.com) -->
        <div class="page" id="page-admin-users">
          <div class="page-title">GESTI√ìN DE USUARIOS</div>
          <div class="page-sub">Administraci√≥n de cuentas</div>
          <div class="card">
            <div
              style="display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;margin-bottom:15px;">
              <div style="display:flex;gap:8px;flex:1;">
                <input type="text" id="adminUsersSearch" placeholder="Buscar usuario..."
                  style="flex:1;padding:8px 12px;background:rgba(255,255,255,.03);border:1px solid var(--border);border-radius:4px;color:var(--text);font-family:VT323,monospace;font-size:.85rem;"
                  oninput="filterAdminUsersPage()">
                <button onclick="loadAdminUsersPage()"
                  style="padding:8px 16px;background:rgba(0,212,255,.15);border:1px solid var(--accent);border-radius:4px;color:var(--accent);cursor:pointer;font-family:VT323,monospace;font-size:.85rem;">‚Üª
                  Actualizar</button>
              </div>
            </div>
            <div id="adminUsersPageList" style="font-size:.75rem;"></div>
          </div>
        </div>
      </main>
    </div>
  </div>



  <div id="bldModal" style="display:none"></div>

  <!-- PERFIL MODAL -->
  <div class="profile-overlay hidden" id="profileOverlay">
    <div class="profile-box">
      <div class="profile-title">üë§ MI PERFIL</div>
      <div class="profile-row"><span class="profile-label">Usuario</span><span class="profile-val"
          id="profUsername">‚Äî</span></div>
      <div class="profile-row"><span class="profile-label">Email</span><span class="profile-val" id="profEmail"
          style="color:var(--dim)">‚Äî</span></div>
      <div class="profile-row"><span class="profile-label">Rol</span><span class="profile-val"
          id="profRole">player</span></div>
      <hr class="profile-sep">
      <div class="profile-section">Cambiar nombre de usuario (solo 1 vez)</div>
      <div class="profile-row">
        <input class="profile-input" id="profNewName" placeholder="Nuevo nombre..." maxlength="15">
      </div>
      <div style="font-size:.62rem;color:var(--dim);margin-bottom:10px;">4-15 caracteres, letras/n√∫meros/_/-. Solo
        puedes cambiarlo una vez.</div>
      <div class="profile-actions">
        <button class="profile-btn save" id="profChangeNameBtn" onclick="doChangeUsername()">‚úì Cambiar nombre</button>
      </div>
      <hr class="profile-sep">
      <div class="profile-section" style="color:var(--danger);">‚ö† Zona de peligro</div>
      <div style="font-size:.62rem;color:var(--dim);margin-bottom:10px;">Escribe el nombre exacto de tu aldea activa o
        tu usuario seg√∫n la acci√≥n que vayas a realizar. Estas acciones son irreversibles.</div>
      <div class="profile-actions" style="flex-direction:column;gap:8px;">
        <button class="profile-btn danger" onclick="doDeleteVillage()" style="font-size:.75rem;">üèö Borrar aldea activa
          <span id="profVillageName" style="opacity:.7;font-size:.7rem;"></span></button>
        <button class="profile-btn danger" onclick="doDeleteAccount()">üóë Eliminar mi cuenta</button>
        <button class="profile-btn cancel" onclick="closeProfile()">Cerrar</button>
      </div>
      <div class="profile-msg" id="profMsg"></div>
    </div>
  </div>

  <!-- ADMIN RECURSOS PANEL (v0.19) -->
  <div class="admin-overlay hidden" id="adminOverlay">
    <div class="admin-box">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
        <div class="admin-title" style="margin:0;">‚öô PANEL DE CONTROL SUPREMO</div>
        <button class="admin-btn cancel" style="padding:6px 12px;font-size:0.85rem;" onclick="closeAdmin()">‚úï
          Cerrar</button>
      </div>

      <!-- Buscador de jugadores -->
      <div style="margin-bottom: 10px; font-size: 0.7rem; color: var(--dim);">BUSCAR JUGADOR (EMAIL O USERNAME)</div>
      <div class="admin-search-wrap">
        <input class="admin-input-search" id="adSearchInp" placeholder="Ej: jesus_33..."
          onkeypress="if(event.key==='Enter') searchAdminPlayer()">
        <button class="admin-btn search" onclick="searchAdminPlayer()">Buscar</button>
        <!-- v1.17: Bot√≥n Ver todos usuarios (solo para sementalac@gmail.com) -->
        <button class="admin-btn search" id="adminViewAllBtn" onclick="openAdminUsersPage()"
          style="background:rgba(0,212,255,.15);display:none;">üë• Ver todos</button>
      </div>

      <div id="adSearchResults" class="admin-results-box">
        <div style="font-size: 0.8rem; margin-bottom: 8px; color: var(--accent);">Resultados:</div>
        <div id="adPlayersList"></div>
      </div>

      <div id="adVillagesBox" class="admin-results-box" style="border-color: var(--danger);">
        <div style="font-size: 0.8rem; margin-bottom: 8px; color: var(--danger);">Aldeas del jugador:</div>
        <div id="adVillagesList"></div>
      </div>

      <div id="adEditBox" style="display:none; border-top: 1px solid var(--border); padding-top: 20px;">
        <div style="font-size: 0.8rem; margin-bottom: 15px; color: var(--text); text-align:center;">
          Editando aldea: <b id="adEditingName" style="color:var(--accent2)">-</b>
        </div>

        <div class="admin-row"><span class="admin-label">üå≤ Madera</span><input class="admin-input" id="adMadera"
            type="number"></div>
        <div class="admin-row"><span class="admin-label">‚õ∞Ô∏è Piedra</span><input class="admin-input" id="adPiedra"
            type="number"></div>
        <div class="admin-row"><span class="admin-label">‚öôÔ∏è Hierro</span><input class="admin-input" id="adHierro"
            type="number"></div>
        <div class="admin-row"><span class="admin-label">üåæ Prov.</span><input class="admin-input" id="adProv"
            type="number"></div>
        <div class="admin-row"><span class="admin-label">‚ú® Esencia</span><input class="admin-input" id="adEsencia"
            type="number"></div>
        <div class="admin-row"><span class="admin-label">üë§ Aldeanos</span><input class="admin-input" id="adAldeanos"
            type="number"></div>
        <div class="admin-row"><span class="admin-label">‚≠ê Experiencia</span><input class="admin-input"
            id="adExperience" type="number"></div>

        <div class="admin-actions" style="display:flex; gap:10px; margin-top:20px;">
          <button class="admin-btn apply" style="flex:1" onclick="adminApplyUniversal()">‚úì Guardar Cambios</button>
          <button class="admin-btn cancel" onclick="closeAdmin()">Cerrar</button>
        </div>
      </div>

      <div id="adminMsg" style="font-size:.7rem; margin-top:15px; min-height:16px; text-align:center; color:var(--ok);">
      </div>

      <!-- ‚îÄ‚îÄ Reparaci√≥n Global ‚îÄ‚îÄ -->
      <div style="border-top:1px solid var(--border);margin-top:20px;padding-top:16px;">
      <!-- ‚îÄ‚îÄ Aldeas Fantasma ‚îÄ‚îÄ -->
      <div style="border-top:1px solid var(--border);margin-top:20px;padding-top:16px;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
          <div style="font-size:.7rem;color:var(--dim);letter-spacing:.1em;">üèöÔ∏è ALDEAS FANTASMA (TEST PvP)</div>
          <button class="admin-btn search" onclick="ghostToggleForm()" style="font-size:.68rem;padding:4px 10px;">+ Nueva</button>
        </div>
        <div id="ghostForm" style="display:none;background:var(--bg);border:1px solid var(--border);border-radius:4px;padding:12px;margin-bottom:10px;">
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px;">
            <div><div style="font-size:.62rem;color:var(--dim);margin-bottom:3px;">NOMBRE</div>
              <input id="ghostName" placeholder="Aldea Oscura" style="width:100%;background:var(--panel2);border:1px solid var(--border);color:var(--text);border-radius:3px;padding:5px 8px;font-family:VT323,monospace;font-size:.85rem;"></div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;">
              <div><div style="font-size:.62rem;color:var(--dim);margin-bottom:3px;">X</div>
                <input id="ghostX" type="number" value="100" style="width:100%;background:var(--panel2);border:1px solid var(--border);color:var(--text);border-radius:3px;padding:5px 8px;font-family:VT323,monospace;font-size:.85rem;"></div>
              <div><div style="font-size:.62rem;color:var(--dim);margin-bottom:3px;">Y</div>
                <input id="ghostY" type="number" value="100" style="width:100%;background:var(--panel2);border:1px solid var(--border);color:var(--text);border-radius:3px;padding:5px 8px;font-family:VT323,monospace;font-size:.85rem;"></div>
            </div>
          </div>
          <div style="font-size:.62rem;color:var(--dim);margin-bottom:6px;">TROPAS (deja en 0 las que no quieras)</div>
          <div id="ghostTroopInputs" style="display:grid;grid-template-columns:repeat(3,1fr);gap:6px;margin-bottom:10px;"></div>
          <div style="font-size:.62rem;color:var(--dim);margin-bottom:6px;">NIVEL MURALLA</div>
          <input id="ghostWall" type="number" value="0" min="0" max="20" style="width:80px;background:var(--panel2);border:1px solid var(--border);color:var(--text);border-radius:3px;padding:4px 6px;font-family:VT323,monospace;font-size:.85rem;margin-bottom:10px;">
          <div style="display:flex;gap:8px;">
            <button class="admin-btn apply" style="flex:1;" onclick="ghostCreate()">‚úì Crear Aldea Fantasma</button>
            <button class="admin-btn cancel" onclick="ghostToggleForm()">Cancelar</button>
          </div>
        </div>
        <div id="ghostList" style="font-size:.72rem;"></div>
      </div>

        <div style="font-size:.7rem;color:var(--dim);margin-bottom:8px;letter-spacing:.1em;">MANTENIMIENTO GLOBAL</div>
        <div style="font-size:.68rem;color:var(--dim);margin-bottom:10px;">
          Fase 1: escanea todas las aldeas y muestra un informe de problemas sin tocar nada.
          Fase 2: confirmas t√∫ manualmente antes de que se aplique cualquier cambio.
        </div>
        <button id="repairBtn" class="admin-btn"
          style="width:100%;background:rgba(0,212,255,.1);border-color:var(--accent);color:var(--accent);"
          onclick="adminRepairAll()">
          üîç Escanear Todo (Solo lectura)
        </button>
        <div id="repairLog"
          style="display:none;margin-top:12px;background:var(--bg);border:1px solid var(--border);border-radius:6px;padding:10px;font-size:.65rem;max-height:220px;overflow-y:auto;font-family:monospace;line-height:1.5;">
        </div>
        <div id="repairConfirmBox"
          style="display:none;margin-top:10px;border:1px solid var(--danger);border-radius:6px;padding:12px;background:rgba(255,61,90,.05);">
          <div style="font-size:.7rem;color:var(--danger);margin-bottom:8px;">
            ‚ö†Ô∏è Se han detectado <b id="repairConfirmCount">0</b> aldea(s) con problemas.<br>
            Revisa el informe arriba antes de continuar.
          </div>
          <div style="display:flex;gap:8px;">
            <button id="repairConfirmBtn" class="admin-btn apply" style="flex:1;" onclick="adminRepairConfirm()">‚úì
              Aplicar Reparaciones</button>
            <button class="admin-btn cancel"
              onclick="document.getElementById('repairConfirmBox').style.display='none'">Cancelar</button>
          </div>
        </div>
      </div>

      <!-- v1.30: Mensaje del d√≠a (MOTD) -->
      <div style="border-top:1px solid var(--border);padding-top:16px;margin-top:16px;">
        <div style="font-size:.7rem;color:var(--dim);letter-spacing:.08em;margin-bottom:8px;">üì¢ MENSAJE DEL D√çA
          (visible para todos al entrar)</div>
        <textarea id="motdInput" rows="3" placeholder="Escribe un mensaje para todos los jugadores‚Ä¶"
          style="width:100%;background:rgba(255,255,255,.03);border:1px solid var(--border);border-radius:4px;color:var(--text);font-family:VT323,monospace;font-size:.85rem;padding:8px;resize:vertical;box-sizing:border-box;"></textarea>
        <div style="display:flex;gap:8px;margin-top:8px;align-items:center;">
          <button class="admin-btn search" onclick="saveMOTD()" style="background:rgba(0,212,255,.15);">üíæ Guardar
            mensaje</button>
          <button class="admin-btn cancel" onclick="clearMOTD()" style="font-size:.7rem;">üóë Borrar mensaje</button>
          <span id="motdSaveMsg" style="font-size:.7rem;color:var(--ok);"></span>
        </div>
      </div>
    </div>
  </div>

  <!-- v1.30: Modal MOTD para jugadores -->
  <div id="motdModal"
    style="display:none;position:fixed;inset:0;z-index:99999;background:rgba(0,0,0,.75);display:none;align-items:center;justify-content:center;">
    <div
      style="background:var(--panel);border:1px solid var(--accent);border-radius:10px;padding:24px;max-width:480px;width:90%;font-family:VT323,monospace;box-shadow:0 0 40px rgba(0,212,255,.2);">
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:16px;">
        <span style="font-size:1.6rem;">üì¢</span>
        <div style="font-size:1.1rem;color:var(--accent);letter-spacing:.06em;">MENSAJE DEL ADMINISTRADOR</div>
      </div>
      <div id="motdModalText"
        style="font-size:.9rem;color:var(--text);line-height:1.6;white-space:pre-wrap;padding:12px;background:rgba(0,212,255,.05);border:1px solid rgba(0,212,255,.2);border-radius:6px;margin-bottom:16px;">
      </div>
      <button onclick="closeMOTD()"
        style="width:100%;padding:10px;background:rgba(0,212,255,.15);border:1px solid var(--accent);border-radius:4px;color:var(--accent);font-family:VT323,monospace;font-size:1rem;cursor:pointer;letter-spacing:.06em;">‚úì
        ENTENDIDO</button>
    </div>
  </div>

  <div class="version-footer" id="versionFooter">EPIC WARRIORS v1.44</div>

  <!-- M√≥dulos JS ‚Äî cargados al final del body para que el DOM exista -->
  <!-- Datos est√°ticos primero (NPC_CASTLES) -->
  <script src="game-data.js"></script>
  <!-- M√≥dulos del juego ‚Äî v1.44 -->
  <script src="game-constants.js?v=1.44"></script>
  <script src="game-troops.js?v=1.44"></script>
  <script src="game-combat.js?v=1.44"></script>
  <script src="game-engine.js?v=1.44"></script>
  <script src="game-ui.js?v=1.44"></script>
  <script src="game-social.js?v=1.44"></script>
  <script src="game-smithy.js?v=1.44"></script>
  <script src="game-auth.js?v=1.44"></script>
  <!-- M√≥dulos originales -->
  <script src="game-simulator.js?v=1.44"></script>
  <script src="game-admin.js?v=1.44"></script>
  <script>
    // ============================================================
    // CONFIG
    // ============================================================
    // --- Supabase (DEV) ---
    // NOTE: The anon key is safe to include in the client for development, but your database must enforce RLS.
    // Globals (sbClient, currentUser, etc.) definidos en game-globals.js (cargado en <head>).

    // ============================================================
    // TROOP TYPES ‚Äî normal (ocupa barracas + gasta provisiones) vs criatura
    // ============================================================

    // Rango de visi√≥n/ataque (distancia Chebyshev en casillas del mapa)

    // ============================================================
    // CORE ‚Äî initGame, carga de aldeas, guardado, tick
    // ============================================================

    async function initGame() {
      if (!currentUser) return;

      // 1. Ensure profile exists and get it
      let myName = (currentUser.email || '').split('@')[0];
      await ensureProfile(currentUser.id, myName);

      const profile = await getMyPlayerData();
      myName = profile?.username || myName;
      const myXP = profile?.experience || 0;
      // Guardar stats de batallas en variable global para inyectar en state tras loadMyVillages
      window._profileBattles = {
        battles_won_pvp:  profile?.battles_won_pvp  || 0,
        battles_lost_pvp: profile?.battles_lost_pvp || 0,
        battles_won_npc:  profile?.battles_won_npc  || 0
      };

      const elUser = document.getElementById('ovUser');
      if (elUser) elUser.textContent = myName;
      const elXP = document.getElementById('ovExperience');
      if (elXP) elXP.textContent = formatNumber(myXP);
      const elTop = document.getElementById('topbarUsername');
      if (elTop) elTop.textContent = myName;

      try {
        await loadMyVillages();
        await loadPlayerObjectives();

        if (myVillages.length === 0) {
          await createFirstVillage();
          // Reload to get the fresh full data structure
          await loadMyVillages();
        }

        if (myVillages.length === 0) {
          showNotif('Error: No se pudo cargar ninguna aldea.', 'err');
          return;
        }

        // Select first village by default
        activeVillage = myVillages[0]; // Object ref

        // Inyectar contadores de batallas desde profiles en el state
        if (window._profileBattles && activeVillage && activeVillage.state) {
          activeVillage.state.battles_won_pvp  = window._profileBattles.battles_won_pvp;
          activeVillage.state.battles_lost_pvp = window._profileBattles.battles_lost_pvp;
          activeVillage.state.battles_won_npc  = window._profileBattles.battles_won_npc;
        }

        // Refresh UI
        populateVillageSel();
        // Usar _initSwitch para no pisar el sessionStorage durante el arranque
        window._suppressSessionSave = true;
        switchVillage(activeVillage.id);
        window._suppressSessionSave = false;

      } catch (e) {
        console.error('initGame error:', e);
        showNotif('Error cr√≠tico al iniciar juego.', 'err');
        return;
      }

      // Start Loops
      clearInterval(uiTimer);
      uiTimer = setInterval(tick, 1000);
      clearInterval(autoSaveTimer);
      // autoSaveTimer y processRecalls: eliminados. Modelo evento-reactivo puro.
      // El guardado ocurre en scheduleSave() tras acciones del jugador.
      // processRecalls se llama una vez al login en initGame.

      if (typeof resetUiAnimation === 'function') resetUiAnimation();
      if (typeof ensureUiAnim === 'function') ensureUiAnim();

      if (typeof loadAllVillages === 'function') loadAllVillages();
      // Cargar estado de alianza para el overview (sin bloquear)
      refreshMyAlliance().catch(function () { });

      // ‚îÄ‚îÄ One-shot al login: √∫nica ronda de red ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      checkIncomingAttacks();
      updateLastSeen();
      updateOnlineCount();
      processRecalls();
      updateUnreadCount(); // Actualizar badge de mensajes no le√≠dos

      // Mostrar/ocultar bot√≥n admin seg√∫n email del usuario autenticado
      checkAdminButton();

      tick();
      showNotif('¬°Bienvenido, comandante!', 'ok');
      checkAndShowMOTD();

      if (isAdmin()) {
        showNotif('üîí Modo Admin Detectado', 'accent');
      }

      // Restaurar posici√≥n tras F5 (sessionStorage)
      // Espera 200ms para que initGame termine del todo antes de restaurar
      setTimeout(function restoreSession(attempts) {
        try {
          var lastVillage = sessionStorage.getItem('EW_lastVillage');
          var lastPage = sessionStorage.getItem('EW_lastPage');
          if (!lastVillage && !lastPage) return; // nada que restaurar

          if (myVillages.length === 0 && attempts < 50) {
            return setTimeout(function () { restoreSession(attempts + 1); }, 100);
          }

          if (lastVillage && myVillages.find(function (v) { return v.id === lastVillage; })) {
            window._suppressSessionSave = true;  // no pisar el valor al restaurar
            switchVillage(lastVillage);
            window._suppressSessionSave = false;
          }
          if (lastPage && lastPage !== 'overview') {
            var navEl = document.querySelector('.nav-item[onclick*="\'' + lastPage + '\'"]');
            showPage(lastPage, navEl);
          }
          var cx = sessionStorage.getItem('EW_camX');
          var cy = sessionStorage.getItem('EW_camY');
          if (cx && cy) { mapCamX = parseInt(cx); mapCamY = parseInt(cy); }
        } catch (e) { console.warn('restoreSession error:', e); }
      }, 200);
    }

    // ============================================================
    // OBJECTIVES
    // ============================================================
    async function loadPlayerObjectives() {
      if (!currentUser) return;
      try {
        const { data } = await sbClient.from('player_objectives').select('*').eq('user_id', currentUser.id);
        if (data) playerObjectives = data;
      } catch (e) { }
    }

    async function updateObjective(id, status) {
      if (!currentUser) return;
      try {
        await sbClient.from('player_objectives').upsert({ user_id: currentUser.id, objective_id: id, status: status, last_interaction: new Date().toISOString() });
        await loadPlayerObjectives();
        renderMap();
      } catch (e) { }
    }

    // ============================================================
    // VILLAGES & DATA MAPPING
    // ============================================================
    async function loadMyVillages() {
      // We need to fetch villages AND their resources/buildings/troops to construct the "state" object
      // expected by the game engine.

      // 1. Fetch Villages ‚Äî columnas reales: id, owner_id, name, cx, cy, build_queue, mission_queue, summoning_queue, training_queue, last_aldeano_at, created_at
      const { data: villages, error: vErr } = await sbClient.from('villages')
        .select('id, owner_id, name, cx, cy, build_queue, mission_queue, summoning_queue, training_queue, last_aldeano_at, created_at')
        .eq('owner_id', currentUser.id)
        .order('created_at', { ascending: true });

      if (vErr) { console.error('Error fetching villages:', vErr); throw vErr; }


      if (!villages || villages.length === 0) {
        myVillages = [];
        return;
      }

      // 2. Fetch related data for ALL villages
      const loaded = [];

      for (const v of villages) {
        // Fetch Resources (Using maybeSingle to avoid 406 error if none found)
        let { data: res, error: rErr } = await sbClient.from('resources').select('*').eq('village_id', v.id).maybeSingle();
        if (rErr) console.warn('Error loading resources for village', v.id, rErr);

        // SELF-HEALING: If resources missing, create default
        if (!res) {
          const defRes = { village_id: v.id, madera: 500, piedra: 300, hierro: 100, prov: 0, esencia: 0 };
          const { data: newRes, error: insErr } = await sbClient.from('resources').insert(defRes).select().single();
          if (!insErr) res = newRes;
          else {
            console.error('Failed to self-heal resources:', insErr);
            res = defRes; // Fallback to memory object
          }
        }

        let { data: blds, error: bErr } = await sbClient.from('buildings').select('*').eq('village_id', v.id).maybeSingle();
        if (bErr) console.warn('Error loading buildings for village', v.id, bErr);

        // SELF-HEALING: If buildings missing
        if (!blds) {
          const defBlds = { village_id: v.id, aserradero: 1, cantera: 1, minehierro: 1, granja: 1, almacen: 1, torre: 1, barracas: 1, circulo: 0, reclutamiento: 0, muralla: 0, lab: 0 };
          const { data: newBlds, error: insErr } = await sbClient.from('buildings').insert(defBlds).select().single();
          if (!insErr) blds = newBlds;
          else {
            console.error('Failed to self-heal buildings:', insErr);
            blds = defBlds;
          }
        }

        let { data: trp, error: tErr } = await sbClient.from('troops').select('*').eq('village_id', v.id).maybeSingle();
        if (tErr) console.warn('Error loading troops for village', v.id, tErr);

        // SELF-HEALING: If troops missing
        if (!trp) {
          const defTrp = { village_id: v.id };
          Object.keys(TROOP_TYPES).forEach(k => {
            defTrp[k] = (k === 'aldeano' ? 50 : 0);
          });
          const { data: newTrp, error: insErr } = await sbClient.from('troops').insert(defTrp).select().single();
          if (!insErr) trp = newTrp;
          else {
            console.error('Failed to self-heal troops:', insErr);
            trp = defTrp;
          }
        }

        let { data: crs, error: cErr } = await sbClient.from('creatures').select('*').eq('village_id', v.id).maybeSingle();
        if (cErr) console.warn('Error loading creatures for village', v.id, cErr);

        // SELF-HEALING: If creatures missing
        if (!crs) {
          const defCrs = { village_id: v.id };
          Object.keys(CREATURE_TYPES).forEach(k => {
            defCrs[k] = 0;
          });
          const { data: newCrs, error: insErr } = await sbClient.from('creatures').insert(defCrs).select().single();
          if (!insErr) crs = newCrs;
          else {
            console.error('Failed to self-heal creatures:', insErr);
            crs = defCrs;
          }
        }


        // If data is missing (maybe insert failed too), try to recover using defaults so the game doesn't break
        const safeRes = res || { madera: 500, piedra: 300, hierro: 100, prov: 0, esencia: 0 };
        const safeBlds = blds || { aserradero: 1, cantera: 1, minehierro: 1, granja: 1, almacen: 1, torre: 1, barracas: 1, circulo: 0, reclutamiento: 0, muralla: 0, lab: 0, torreinvocacion: 0 };
        const safeTrp = trp || {}; // Si no hay fila de troops, empezar en 0 ‚Äî no hardcodear 50

        // MAPPING: SQL -> Game State JSON
        const state = {
          resources: {
            madera: Number(safeRes.madera) || 0,
            piedra: Number(safeRes.piedra) || 0,
            hierro: Number(safeRes.hierro) || 0,
            provisiones: Number(safeRes.prov) || 0,
            esencia: Number(safeRes.esencia) || 0,
            aldeanos: 0
          },
          aldeanos_assigned: {
            madera: Number(safeRes.w_madera) || 0,
            piedra: Number(safeRes.w_piedra) || 0,
            hierro: Number(safeRes.w_hierro) || 0,
            provisiones: Number(safeRes.w_prov) || 0,
            esencia: Number(safeRes.w_esencia) || 0
          },
          // v0.17 ‚Äî mapa completo de tropas desde DB
          troops: {},
          buildings: {},
          build_queue: v.build_queue || null,
          mission_queue: (v.mission_queue || []).filter(function (m) {
            // Descartar solo misiones con finish_at hace m√°s de 7 d√≠as (corruptas)
            var ft = m.finish_at ? new Date(m.finish_at).getTime() : 0;
            return (Date.now() - ft) < 7 * 24 * 3600 * 1000;
          }),
          summoning_queue: (v.summoning_queue || []),
          training_queue: (v.training_queue || []).filter(function (t) {
            var ft = t.finish_at ? new Date(t.finish_at).getTime() : 0;
            return (Date.now() - ft) < 7 * 24 * 3600 * 1000;
          }),
          last_updated: safeRes.last_update || new Date().toISOString(),
          last_aldeano_at: v.last_aldeano_at || null, // timer discreto de aldeanos
          // Legacy/Compat flags
          _aldeanos_total_mode: true,
          owner_name: currentUser.email
        };

        Object.keys(TROOP_TYPES).forEach(k => {
          state.troops[k] = Number(safeTrp[k]) || 0;
        });
        state.resources.aldeanos = state.troops.aldeano || 0;

        // Map creatures from DB
        state.creatures = {};
        const safeCrs = crs || {};
        Object.keys(CREATURE_TYPES).forEach(k => {
          state.creatures[k] = Number(safeCrs[k]) || 0;
        });


        // Map buildings flat columns -> nested objects
        // Columns: aserradero, cantera, etc.
        // bldKeys derivado de BUILDINGS ‚Äî a√±adir edificio nuevo solo en BUILDINGS[]
        const bldKeys = BUILDINGS.map(b => b.id);
        // Edificios activos desde nivel 1 (starter); el resto arrancan en 0 (no construidos)
        const starterBlds = ['aserradero', 'cantera', 'minehierro', 'granja', 'almacen', 'torre', 'barracas'];
        bldKeys.forEach(k => {
          var raw = safeBlds[k];
          // Si la columna existe en DB, usar ese valor. Si no existe a√∫n (edificio nuevo), defaultear correctamente.
          var lvl = (raw !== undefined && raw !== null) ? Number(raw) : (starterBlds.includes(k) ? 1 : 0);
          state.buildings[k] = { level: lvl };
        });

        // Attach state to village object
        v.state = state;
        v.x = Number(v.cx); v.y = Number(v.cy); // Ensure numbers

        // IMMEDIATE OFFLINE PROGRESSION:
        // Check if a building finished while we were offline
        if (v.state.build_queue) {
          const oldQ = JSON.stringify(v.state.build_queue);
          v.state = resolveQueue(v.state);
          const newQ = JSON.stringify(v.state.build_queue);

          if (oldQ !== newQ) {
            // We use the new generic save helper
            await saveVillage(v);
          }
        }

        loaded.push(v);
      }

      myVillages = loaded;
    }

    async function loadAllVillages() {
      // Cargar TODAS las aldeas del mapa (para el mapa global)
      // FIX: 'state' and 'user_id' do not exist in schema. Use 'owner_id'.
      // We don't have 'state' column in villages, so we can't show points/score yet unless we join resources.
      var r = await sbClient.from('villages').select('id, owner_id, name, cx, cy');
      if (r.error) { console.error('Error loading world:', r.error); return; }
      if (r.data) {
        allVillages = r.data.map(function (v) {
          v.x = Number(v.cx); v.y = Number(v.cy); // Ensure numbers
          return v;
        });
      }
    }

    function populateVillageSel() {
      var sel = document.getElementById('villageSel');
      if (!sel) return;
      sel.innerHTML = '';
      myVillages.forEach(function (v) {
        var o = document.createElement('option');
        o.value = v.id;
        o.textContent = v.name + ' [' + v.x + ',' + v.y + ']';
        sel.appendChild(o);
      });
      if (activeVillage) sel.value = activeVillage.id;
    }

    function switchVillage(id) {
      var v = myVillages.find(function (v) { return v.id === id; });
      if (v) {
        activeVillage = v;
        mapCamX = null;
        mapCamY = null;
        resetUiAnimation();
        var sel = document.getElementById('villageSel');
        if (sel) sel.value = v.id;
        // Guardar aldea seleccionada para restaurar tras F5 (no durante arranque)
        if (!window._suppressSessionSave) { try { sessionStorage.setItem('EW_lastVillage', v.id); } catch (e) { } }
        tick();
        // Re-renderizar la p√°gina activa si es sensible a la aldea seleccionada
        var activePage = document.querySelector('.page.active');
        if (activePage) {
          var pid = activePage.id;
          if (pid === 'page-recursos') { renderRecursos && renderRecursos(); }
          if (pid === 'page-buildings') { renderBuildings && renderBuildings(calcRes(activeVillage.state)); }
          if (pid === 'page-fleet') { renderTroops && renderTroops(); renderTrainingQueue && renderTrainingQueue(); }
          if (pid === 'page-creatures') { renderCreatures && renderCreatures(); renderSummoningQueue && renderSummoningQueue(); }
          if (pid === 'page-map') { renderMap && renderMap(); }
          if (pid === 'page-overview') { renderReinforcementsPanel && renderReinforcementsPanel(); }
        }
      }
    }

    function getWorkerSum(w) {
      if (!w) return 0;
      return (w.madera || 0) + (w.piedra || 0) + (w.hierro || 0) + (w.provisiones || 0) + (w.esencia || 0);
    }

    async function createFirstVillage() {
      showNotif('Fundando primera colonia...', 'ok');

      let cx, cy;
      let found = false;
      for (let i = 0; i < 100; i++) {
        cx = Math.floor(Math.random() * MAP_SIZE);
        cy = Math.floor(Math.random() * MAP_SIZE);
        // Simple check (collisions will fail on insert unique constraint)
        const { error } = await sbClient.from('villages').select('id').eq('cx', cx).eq('cy', cy).single();
        if (error) { found = true; break; } // Assuming error means "not found" (good)
      }

      const vName = 'Aldea 1';

      // Insert Village
      const { data: v, error: err } = await sbClient.from('villages').insert({
        owner_id: currentUser.id,
        name: vName,
        cx: cx,
        cy: cy,
        build_queue: null
      }).select().single();

      if (err) { throw new Error(err.message); }

      // Insert Related
      await sbClient.from('resources').insert({ village_id: v.id });
      // NEW: Start everything at Level 1
      await sbClient.from('buildings').insert({
        village_id: v.id,
        aserradero: 1, cantera: 1, minehierro: 1, granja: 1, almacen: 1, torre: 1, barracas: 1, circulo: 1, reclutamiento: 1, muralla: 0, lab: 0
      });
      const initialTroops = { village_id: v.id };
      Object.keys(TROOP_TYPES).forEach(k => {
        initialTroops[k] = (k === 'aldeano' ? 50 : 0);
      });
      await sbClient.from('troops').insert(initialTroops);
    }

    // Generic save function for ANY village (not just active)
    async function saveVillage(v) {
      if (!v || !currentUser) return;

      // Snapshot: calcular recursos actuales antes de guardar
      // Esto asegura que guardamos el valor real acumulado, no el del √∫ltimo tick
      snapshotResources(v.state);

      const s = v.state;
      const w = s.aldeanos_assigned || {};
      // 1. Update Resources
      const { error: rErr } = await sbClient.from('resources').update({
        madera: s.resources.madera,
        piedra: s.resources.piedra,
        hierro: s.resources.hierro,
        prov: s.resources.provisiones,
        esencia: s.resources.esencia,
        w_madera: (s.aldeanos_assigned && s.aldeanos_assigned.madera) || 0,
        w_piedra: (s.aldeanos_assigned && s.aldeanos_assigned.piedra) || 0,
        w_hierro: (s.aldeanos_assigned && s.aldeanos_assigned.hierro) || 0,
        w_prov: (s.aldeanos_assigned && s.aldeanos_assigned.provisiones) || 0,
        w_esencia: (s.aldeanos_assigned && s.aldeanos_assigned.esencia) || 0,
        last_update: new Date().toISOString()
      }).eq('village_id', v.id);

      if (rErr) throw rErr;

      // 2. Update Buildings
      const bUpd = {};
      for (let k in s.buildings) { bUpd[k] = s.buildings[k].level; }
      const { error: bErr } = await sbClient.from('buildings').update(bUpd).eq('village_id', v.id);
      if (bErr) {
        console.error('Buildings save error:', bErr);
        throw bErr;
      }

      // 3. Update Troops ‚Äî all types
      const trpUpd = {};
      const trps = s.troops || defaultTroops();
      Object.keys(TROOP_TYPES).forEach(function (k) { trpUpd[k] = trps[k] || 0; });
      // Sync aldeanos: el total real de aldeanos en barracas se guarda en troops.aldeano.
      // resources.aldeanos es la fuente de verdad en memoria ‚Äî actualizamos troops para que coincida.
      // Usamos una asignaci√≥n directa sin ||, para que aldeano=0 sea un valor v√°lido y no se sobreescriba.
      trpUpd.aldeano = (s.resources.aldeanos !== undefined && s.resources.aldeanos !== null)
        ? Math.max(0, Math.floor(s.resources.aldeanos))
        : (trps.aldeano || 0);
      // Mantener sincronizado el estado en memoria tambi√©n
      s.troops.aldeano = trpUpd.aldeano;
      await sbClient.from('troops').update(trpUpd).eq('village_id', v.id);

      // 4b. Actualizar military_score ‚Äî suma TODAS las aldeas + criaturas del jugador
      try {
        const allVils = await sbClient.from('villages').select('id').eq('owner_id', currentUser.id);
        if (!allVils.error && allVils.data && allVils.data.length > 0) {
          const vilIds = allVils.data.map(vv => vv.id);
          const allTrps = await sbClient.from('troops').select('*').in('village_id', vilIds);
          const allCrs = await sbClient.from('creatures').select('*').in('village_id', vilIds);
          let grandTotal = 0;
          if (!allTrps.error && allTrps.data) {
            allTrps.data.forEach(row => { Object.keys(TROOP_TYPES).forEach(k => { grandTotal += (Number(row[k]) || 0); }); });
          }
          if (!allCrs.error && allCrs.data) {
            allCrs.data.forEach(row => { Object.keys(CREATURE_TYPES).forEach(k => { grandTotal += (Number(row[k]) || 0); }); });
          }
          await sbClient.from('profiles').update({ military_score: grandTotal }).eq('id', currentUser.id);
        }
      } catch (e) { console.warn('military_score update failed', e); }

      // 4c. Update Creatures
      const crUpd = {};
      const crs = s.creatures || defaultCreatures();
      Object.keys(CREATURE_TYPES).forEach(function (k) { crUpd[k] = crs[k] || 0; });
      await sbClient.from('creatures').update(crUpd).eq('village_id', v.id);

      // 4. Update Village (Queue, Missions, Name, aldeano timer, summoning queue, training queue)
      await sbClient.from('villages').update({
        build_queue: s.build_queue,
        mission_queue: s.mission_queue || [],
        summoning_queue: s.summoning_queue || [],
        training_queue: s.training_queue || [],
        name: v.name,
        last_aldeano_at: s.last_aldeano_at || null
      }).eq('id', v.id);
    }

    async function flushVillage() {
      if (!activeVillage) return;
      if (isFlushing) { pendingFlush = true; return; }

      isFlushing = true;
      setSave('saving');

      try {
        await saveVillage(activeVillage);
        setSave('saved');
      } catch (e) {
        console.error('Save error details:', e);
        if (e.message) console.error('Message:', e.message);
        setSave('error');
        showNotif('Error guardando: ' + e.message, 'err');
      } finally {
        isFlushing = false;
        if (pendingFlush) {
          pendingFlush = false;
          flushVillage();
        }
      }
    }

    var saveDebounce = null;
    var modalBuildingId = null; // tracks which building is open in modal
    function scheduleSave() {
      clearTimeout(saveDebounce);
      saveDebounce = setTimeout(flushVillage, 2000);
    }

    function setSave(s) {
      var dot = document.getElementById('saveDot');
      var txt = document.getElementById('saveTxt');
      dot.className = 'save-dot ' + s;
      txt.textContent = s === 'saving' ? 'guardando...' : s === 'saved' ? 'guardado' : '';
    }


    // ============================================================
    // UI ANIMATION ‚Äî n√∫meros que suben y bajan suave (tipo barra)
    // ============================================================
    var uiShown = null;
    var uiTarget = null;
    var uiAnimStarted = false;

    // Cache de elementos DOM frecuentes ‚Äî evita querySelector 60 veces/segundo
    var _elCache = {};
    function _el(id) {
      if (!_elCache[id]) _elCache[id] = document.getElementById(id);
      return _elCache[id];
    }

    function resetUiAnimation() {
      uiShown = { madera: 0, piedra: 0, hierro: 0, provisiones: 0, esencia: 0, aldeanos: 0, capPctMa: 0, capPctPi: 0, capPctHi: 0, capPctPr: 0, capPctEs: 0, capPctAld: 0 };
      uiTarget = null;
    }

    function ensureUiAnim() {
      // Animaci√≥n desactivada temporalmente ‚Äî los valores se muestran directos desde calcRes()
      // para garantizar que lo que se ve es exactamente lo que hay en estado.
      // Reactivar cuando el sistema de producci√≥n est√© verificado.
      if (uiAnimStarted) return;
      uiAnimStarted = true;
      function step() {
        if (uiShown && uiTarget) {
          // Sin lerp: copiamos target directamente a shown
          var keys = ['madera', 'piedra', 'hierro', 'provisiones', 'esencia', 'aldeanos', 'capPctMa', 'capPctPi', 'capPctHi', 'capPctPr', 'capPctEs', 'capPctAld'];
          keys.forEach(function (key) { uiShown[key] = uiTarget[key]; });
          renderAnimatedUi();
        }
        requestAnimationFrame(step);
      }
      requestAnimationFrame(step);
    }

    function renderAnimatedUi() {
      if (!activeVillage || !uiShown) return;
      var vs = activeVillage.state;
      var aldGranja = vs.aldeanos_granja || 0;
      var barrCap = getBarracksCapacity(vs.buildings);
      var cap = getCapacity(vs.buildings);

      var madera = Math.round(uiShown.madera || 0);
      var piedra = Math.round(uiShown.piedra || 0);
      var hierro = Math.round(uiShown.hierro || 0);
      var prov = Math.round(uiShown.provisiones || 0);
      var esencia = Math.round(uiShown.esencia || 0);
      var aldLibres = Math.round(uiShown.aldeanos || 0);

      var stored = Math.round(uiShown.stored || 0);
      var capPct = Math.max(0, Math.min(100, uiShown.capPct || 0));

      // Topbar ‚Äî valores
      _el('rMadera').textContent = fmt(madera);
      _el('rPiedra').textContent = fmt(piedra);
      _el('rHierro').textContent = fmt(hierro);
      _el('rProv').textContent = fmt(prov);
      _el('rEsencia').textContent = fmt(esencia);

      // Barras de capacidad individuales por recurso
      function setBar(id, pct, color) {
        var b = _el(id); if (!b) return;
        var cls = pct >= 100 ? 'full' : pct >= 80 ? 'warn' : 'ok';
        b.style.width = pct + '%';
        if (color) b.style.background = color;
        else b.className = 'cap-bar ' + cls;
      }
      setBar('capBarMa', uiShown.capPctMa || 0);
      setBar('capBarPi', uiShown.capPctPi || 0);
      setBar('capBarHi', uiShown.capPctHi || 0);
      setBar('capBarPr', uiShown.capPctPr || 0);
      setBar('capBarEs', uiShown.capPctEs || 0, 'var(--esencia)');
      setBar('capBarAld', uiShown.capPctAld || 0, 'var(--aldeanos)');

      // Overview ‚Äî valores (pueden no existir si se redise√±√≥ la p√°gina)
      if (_el('ovMadera')) _el('ovMadera').textContent = fmt(madera);
      if (_el('ovPiedra')) _el('ovPiedra').textContent = fmt(piedra);
      if (_el('ovHierro')) _el('ovHierro').textContent = fmt(hierro);
      if (_el('ovProv')) _el('ovProv').textContent = fmt(prov);
      if (_el('ovEsencia')) _el('ovEsencia').textContent = fmt(esencia);

      // Arriba: aldeanos libres. Abajo izq: total tropas en base. Abajo der: capacidad.
      var tropasEnBase = getBarracksUsed(vs); // todos los que est√°n en base (no en misi√≥n)
      _el('rAldeanos').textContent = aldLibres;
      if (_el('rTropasBase')) _el('rTropasBase').textContent = tropasEnBase;
      if (_el('rBarrCap')) _el('rBarrCap').textContent = '/ ' + barrCap;
      if (_el('ovAldeanos')) _el('ovAldeanos').textContent = aldLibres + ' libres / ' + aldGranja + ' en granja';
    }

    // ============================================================
    // UI TICK (every second)
    // ============================================================
    function tick() {
      if (!activeVillage) return;

      if (!activeVillage.state.build_queue) activeVillage.state.build_queue = null;
      var oldQ = activeVillage.state.build_queue ? JSON.stringify(activeVillage.state.build_queue) : null;
      if (!activeVillage.state.mission_queue) activeVillage.state.mission_queue = [];
      var oldM = JSON.stringify(activeVillage.state.mission_queue);
      if (!activeVillage.state.summoning_queue) activeVillage.state.summoning_queue = [];
      var oldS = JSON.stringify(activeVillage.state.summoning_queue);

      // ‚îÄ‚îÄ Colas locales ‚Äî cero red ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      activeVillage.state = resolveQueue(activeVillage.state);
      activeVillage.state = resolveSummoningQueue(activeVillage.state);
      activeVillage.state = resolveTrainingQueue(activeVillage.state);

      // Si una cola local complet√≥ ‚Üí guardar
      var newQ2 = activeVillage.state.build_queue ? JSON.stringify(activeVillage.state.build_queue) : null;
      var newM2 = JSON.stringify(activeVillage.state.mission_queue || []);
      var newS2 = JSON.stringify(activeVillage.state.summoning_queue || []);
      if ((oldQ && !newQ2) || (oldM !== newM2) || (oldS !== newS2)) {
        scheduleSave();
      }

      // ‚îÄ‚îÄ resolveMissions ‚Äî REACTIVO, no polling ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      // Solo se lanza cuando el contador local de una misi√≥n llega a cero.
      // NUNCA se llama en cada tick por defecto.
      var _nowMs2 = Date.now();
      var hasMissionDue = (activeVillage.state.mission_queue || []).some(function (m) {
        return m.finish_at && new Date(m.finish_at).getTime() <= _nowMs2;
      });
      if (hasMissionDue && !_missionWatchScheduled) {
        _missionWatchScheduled = true;
        resolveMissions(activeVillage.state).then(function (updated) {
          activeVillage.state = updated;
          _missionWatchScheduled = false;
          scheduleSave();
          // Misi√≥n resuelta ‚Üí hay un informe nuevo en mensajes, actualizar badge
          updateUnreadCount && updateUnreadCount();
        }).catch(function () { _missionWatchScheduled = false; });
      }

      var vs = activeVillage.state;
      var w = vs.aldeanos_assigned || defaultAssignments();
      if (w.esencia === undefined) w.esencia = 0;
      var res = calcRes(vs);
      var prod = getProd(vs.buildings, 0, w);
      var cap = getCapacity(vs.buildings);
      // Porcentaje individual de cada recurso respecto al almac√©n
      var capPctMa = cap > 0 ? Math.min(100, Math.round(res.madera / cap * 100)) : 0;
      var capPctPi = cap > 0 ? Math.min(100, Math.round(res.piedra / cap * 100)) : 0;
      var capPctHi = cap > 0 ? Math.min(100, Math.round(res.hierro / cap * 100)) : 0;
      var capPctPr = cap > 0 ? Math.min(100, Math.round(res.provisiones / cap * 100)) : 0;
      var capPctEs = cap > 0 ? Math.min(100, Math.round(res.esencia / cap * 100)) : 0;
      var barrCapTick = getBarracksCapacity(vs.buildings);
      var aldEnBaseTick = Math.max(0, (vs.troops && vs.troops.aldeano) || 0);
      var capPctAld = barrCapTick > 0 ? Math.min(100, Math.round(aldEnBaseTick / barrCapTick * 100)) : 0;

      // v1.17: Actualizar display de barracas en el tick (para que refleje tropas en movimiento)
      var usedBarracas = getBarracksUsed(vs);
      var barrPctTick = barrCapTick > 0 ? Math.round(usedBarracas / barrCapTick * 100) : 0;
      var elCapTick = document.getElementById('recAldCap');
      if (elCapTick) elCapTick.textContent = usedBarracas + ' / ' + barrCapTick + ' (' + barrPctTick + '%)';

      // IMPORTANTE: tick() NO escribe a state.resources.
      // calcRes() calcula (now - last_updated) cada vez que se llama.
      // Si escribi√©ramos el resultado a state.resources, el siguiente tick
      // volver√≠a a sumar las mismas horas sobre el nuevo valor ‚Äî duplicando infinitamente.
      // state.resources solo se actualiza en snapshotResources() ‚Üí llamado desde saveVillage().
      // tick() solo usa calcRes() para la UI, no para el estado.

      // Production rates (instant√°neos)
      _el('rMaderaR').textContent = '+' + fmt(prod.madera) + '/h';
      _el('rPiedraR').textContent = '+' + fmt(prod.piedra) + '/h';
      _el('rHierroR').textContent = '+' + fmt(prod.hierro) + '/h';
      _el('rProvR').textContent = '+' + fmt(prod.provisiones) + '/h';
      _el('rEsenciaR').textContent = '+' + fmt(prod.esencia) + '/h';

      // Objetivos para animaci√≥n (sube y baja)
      if (!uiShown) resetUiAnimation();
      ensureUiAnim();
      uiTarget = {
        madera: res.madera,
        piedra: res.piedra,
        hierro: res.hierro,
        provisiones: res.provisiones,
        esencia: res.esencia,
        aldeanos: res.aldeanos,
        capPctMa, capPctPi, capPctHi, capPctPr, capPctEs, capPctAld
      };

      if (_el('ovVillageName')) _el('ovVillageName').textContent = activeVillage.name;
      if (_el('ovVillageCoords')) _el('ovVillageCoords').textContent = 'Coordenadas: [' + activeVillage.x + ', ' + activeVillage.y + ']';
      // Overview player stats
      if (_el('ovUser')) {
        var displayUsername = window._playerUsername || (currentUser ? (currentUser.email || '--').split('@')[0] : '--');
        _el('ovUser').textContent = displayUsername;
      }
      if (_el('ovAlliance')) {
        var alTag = (window._playerAllianceTag) ? '[' + window._playerAllianceTag + ']' : '';
        var alName = window._playerAllianceName || '';
        var alStr = alName ? (alName + (alTag ? ' ' + alTag : '')) : (alTag || '‚Äî');
        _el('ovAlliance').textContent = alStr;
      }
      if (_el('ovBattlesWon')) _el('ovBattlesWon').textContent = (vs.battles_won_pvp || 0);
      if (_el('ovBattlesLost')) _el('ovBattlesLost').textContent = (vs.battles_lost_pvp || 0);
      if (_el('ovBattlesNPC')) _el('ovBattlesNPC').textContent = (vs.battles_won_npc || 0);
      // Troop movement alerts in overview
      if (_el('ovAlertsBox')) {
        var alerts = _incomingAttacks || [];
        var allMissions = (vs.mission_queue || []);
        var myOutgoing = allMissions.filter(function (m) { return m.type !== 'return'; });
        var myReturning = allMissions.filter(function (m) { return m.type === 'return'; });
        var alertLines = '';
        alerts.forEach(function (a) {
          var eta = Math.max(0, Math.ceil((new Date(a.finish_at).getTime() - Date.now()) / 1000));
          var fromName = a.fromVillage || 'Enemigo';
          alertLines += '<div style="background:rgba(255,61,90,.07);border:1px solid rgba(255,61,90,.2);border-radius:6px;padding:7px 10px;margin-bottom:5px;">'
            + '<span style="color:var(--danger);">üö® Ataque entrante</span>'
            + '<span style="color:var(--dim);font-size:.72rem;margin-left:8px;">desde ' + escapeHtml(fromName) + '</span>'
            + '<span style="float:right;color:var(--danger);font-size:.75rem;">ETA ' + fmtTime(eta) + '</span>'
            + '</div>';
        });
        myOutgoing.forEach(function (m) {
          var eta = Math.max(0, Math.ceil((new Date(m.finish_at).getTime() - Date.now()) / 1000));
          var ico = m.type === 'spy' ? 'üîç' : m.type === 'found' ? 'üè†' : m.type === 'move' ? '‚öî' : m.type === 'reinforce' ? 'üõ°Ô∏è' : m.type === 'transport' ? 'üì¶' : '‚öîÔ∏è';
          var label = m.type === 'spy' ? 'Espionaje' : m.type === 'found' ? 'Colonos ‚Üí [' + m.tx + ',' + m.ty + ']' : m.type === 'move' ? 'Moviendo tropas ‚Üí [' + m.tx + ',' + m.ty + ']' : m.type === 'reinforce' ? 'Refuerzo ‚Üí [' + m.tx + ',' + m.ty + ']' : m.type === 'transport' ? 'Caravana ‚Üí [' + m.tx + ',' + m.ty + ']' : 'Ataque';
          alertLines += '<div style="background:rgba(0,212,255,.05);border:1px solid rgba(0,212,255,.1);border-radius:6px;padding:7px 10px;margin-bottom:5px;">'
            + '<span style="color:var(--accent);">' + ico + ' ' + label + '</span>'
            + '<span style="float:right;color:var(--accent);font-size:.75rem;">ETA ' + fmtTime(eta) + '</span>'
            + '</div>';
        });
        myReturning.forEach(function (m) {
          var eta = Math.max(0, Math.ceil((new Date(m.finish_at).getTime() - Date.now()) / 1000));
          alertLines += '<div style="background:rgba(79,255,176,.04);border:1px solid rgba(79,255,176,.1);border-radius:6px;padding:7px 10px;margin-bottom:5px;">'
            + '<span style="color:var(--ok);">‚Ü©Ô∏è Tropas regresando</span>'
            + '<span style="float:right;color:var(--ok);font-size:.75rem;">ETA ' + fmtTime(eta) + '</span>'
            + '</div>';
        });
        _el('ovAlertsBox').innerHTML = alertLines || '<span style="color:var(--dim);font-size:.8rem;">Sin movimientos activos.</span>';
      }

      renderQueue(vs);
      updateAlertsButton();
      updateGranjaPanel();
      // Reinforce panel ‚Äî solo cada 60s
      var nowMs = Date.now();
      if (nowMs - _lastReinforcementsCheck > 60000 && document.getElementById('page-overview').classList.contains('active')) {
        _lastReinforcementsCheck = nowMs;
        renderReinforcementsPanel();
      }
      if (document.getElementById('page-buildings').classList.contains('active')) {
        renderBuildings(res);
      }
      if (document.getElementById('page-creatures') && document.getElementById('page-creatures').classList.contains('active')) {
        renderSummoningQueue();
      }
      if (document.getElementById('page-fleet') && document.getElementById('page-fleet').classList.contains('active')) {
        renderTrainingQueue();
      }
    }

    // ============================================================
    // ALERTS ‚Äî incoming attacks detection
    // ============================================================
    var _incomingAttacks = []; // cache updated periodically
    var _lastAlertsCheck = 0;
    var _lastMsgPoll = 0;

    var _lastSeenUpdate = 0;
    var _lastOnlineCheck = 0;
    var _lastReinforcementsCheck = 0;
    var _lastAlliancesCheck = 0;
    var _lastMapLoad = 0;
    var _lastResourceSync = 0;

    async function updateLastSeen() {
      if (!currentUser) return;
      try {
        await sbClient.from('profiles').update({ last_seen: new Date().toISOString() }).eq('id', currentUser.id);
      } catch (e) { }
    }

    async function updateOnlineCount() {
      try {
        var cutoff = new Date(Date.now() - 60000).toISOString(); // last 60s
        var r = await sbClient.from('profiles').select('id', { count: 'exact', head: true }).gte('last_seen', cutoff);
        var count = r.count || 0;
        var el = document.getElementById('activePlayers');
        if (el) el.textContent = 'üü¢ ' + count + ' online';
      } catch (e) { }
    }

    function updateAlertsButton() {
      var count = _incomingAttacks.length;
      var btn = document.getElementById('alertsBtn');
      var badge = document.getElementById('alertsBadge');
      var label = document.getElementById('alertsBtnLabel');
      if (!btn) return;

      if (count > 0) {
        btn.classList.add('has-alerts');
        if (badge) { badge.textContent = count; badge.style.display = 'flex'; }
        if (label) label.textContent = count + ' Ataque' + (count > 1 ? 's' : '');
      } else {
        btn.classList.remove('has-alerts');
        if (badge) badge.style.display = 'none';
        if (label) label.textContent = 'Alertas';
      }

      // Refrescar datos cada 30s sin bloquear el tick
      var now = Date.now();
      if (now - _lastAlertsCheck > 30000) {
        _lastAlertsCheck = now;
        checkIncomingAttacks();
      }
      // Poll mensajes cada 60s ‚Äî query ligera (solo count)
      if (now - _lastMsgPoll > 60000) {
        _lastMsgPoll = now;
        updateUnreadCount && updateUnreadCount();
      }
    }

    async function checkIncomingAttacks() {
      if (!activeVillage || !sbClient || !currentUser) return;
      try {
        // Coordenadas de todas mis aldeas
        var myCoords = myVillages.map(function (v) { return { x: v.x, y: v.y, id: v.id, name: v.name }; });
        if (myCoords.length === 0) return;

        // Cargar mission_queue de aldeas enemigas (las que no son m√≠as)
        var { data, error } = await sbClient
          .from('villages')
          .select('id, name, cx, cy, owner_id, mission_queue')
          .neq('owner_id', currentUser.id);

        if (error || !data) return;

        var attacks = [];
        var now = Date.now();

        data.forEach(function (village) {
          var mq = village.mission_queue;
          if (!Array.isArray(mq)) return;
          mq.forEach(function (m) {
            if (m.type !== 'attack') return;
            // ¬øapunta a alguna de mis aldeas?
            var target = myCoords.find(function (c) { return c.x === m.tx && c.y === m.ty; });
            if (!target) return;
            var finish = new Date(m.finish_at).getTime();
            if (finish <= now) return; // ya lleg√≥, tick la resolver√°
            attacks.push({
              fromName: village.name || '[' + village.cx + ',' + village.cy + ']',
              fromCoords: [village.cx, village.cy],
              toName: target.name,
              toCoords: [m.tx, m.ty],
              finish_at: m.finish_at,
              secsLeft: Math.ceil((finish - now) / 1000)
            });
          });
        });

        // Ordenar por llegada m√°s pr√≥xima
        attacks.sort(function (a, b) { return a.secsLeft - b.secsLeft; });
        _incomingAttacks = attacks;
      } catch (e) {
        console.warn('checkIncomingAttacks error:', e);
      }
    }

    function toggleAlertsPanel() {
      var existing = document.getElementById('alertsModalOverlay');
      if (existing) { existing.remove(); return; }

      var attacks = _incomingAttacks;
      var inner = attacks.length === 0
        ? '<div class="alerts-empty">‚úÖ Sin ataques entrantes detectados</div>'
        : attacks.map(function (a) {
          var t = fmtTime(a.secsLeft);
          return '<div class="alert-item">'
            + '<div class="alert-title">‚öîÔ∏è Ataque entrante a ' + a.toName + '</div>'
            + '<div class="alert-sub">Desde: ' + a.fromName + ' [' + a.fromCoords[0] + ',' + a.fromCoords[1] + ']</div>'
            + '<div class="alert-time">‚è± Llega en: ' + t + '</div>'
            + '</div>';
        }).join('');

      var overlay = document.createElement('div');
      overlay.id = 'alertsModalOverlay';
      overlay.className = 'alerts-modal';
      overlay.innerHTML = '<div class="alerts-panel">'
        + '<div class="alerts-header">'
        + '<h3>üîî Alertas (' + attacks.length + ')</h3>'
        + '<button onclick="document.getElementById(\'alertsModalOverlay\').remove()" style="background:none;border:none;color:var(--dim);cursor:pointer;font-size:1rem;">‚úï</button>'
        + '</div>'
        + inner
        + '</div>';

      // Cierra al click fuera del panel
      overlay.addEventListener('click', function (e) {
        if (e.target === overlay) overlay.remove();
      });

      document.body.appendChild(overlay);
    }

    // ============================================================
    // ============================================================
  </script>
</body>

